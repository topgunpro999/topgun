<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>National Cyber Security Index (NCSI) Top 20 Dashboard</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* 기본 레이아웃 및 폰트 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f4f7f6;
            color: #333;
        }

        /* 헤더 스타일 */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1.2rem 2rem;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            position: relative; /* z-index를 위해 */
            z-index: 1000; /* 지도가 위에 올라오지 않도록 */
        }

        h1 {
            margin: 0;
            font-size: 2rem;
            letter-spacing: 0.05em;
        }

        /* 메인 콘텐츠 컨테이너 */
        main {
            flex: 1; /* 남은 공간을 모두 차지 */
            display: flex;
            padding: 1.5rem;
            gap: 1.5rem; /* 요소들 사이 간격 */
            max-width: 1600px; /* 최대 너비 제한 */
            margin: 0 auto; /* 중앙 정렬 */
            width: 100%; /* 너비 100% 사용 */
        }

        /* 사이드바 스타일 */
        .sidebar {
            flex: 0 0 320px; /* 고정 너비 */
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            overflow-y: auto; /* 내용이 넘칠 경우 스크롤 */
            display: flex;
            flex-direction: column;
            align-items: stretch; /* 자식 요소들이 너비를 채우도록 */
        }

        /* 맵 컨테이너 스타일 */
        .map-container {
            flex: 1; /* 남은 공간 모두 차지 */
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            overflow: hidden; /* 지도가 컨테이너 밖으로 나가지 않도록 */
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #map {
            flex: 1; /* 맵 컨테이너의 남은 공간을 모두 차지 */
            width: 100%;
            height: 100%; /* 매우 중요: 높이를 명시해야 지도가 보임 */
            border-radius: 0 0 12px 12px; /* 하단 모서리 둥글게 */
        }

        /* 섹션 제목 */
        h2 {
            color: #34495e;
            font-size: 1.6rem;
            margin-top: 0;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 0.8rem;
            text-align: center;
        }

        /* NCSI 리스트 스타일 */
        .ncsi-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ncsi-list li {
            padding: 0.8rem 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            transition: background-color 0.2s ease-in-out;
        }

        .ncsi-list li:hover {
            background-color: #f9f9f9;
        }

        .ncsi-list li:last-child {
            border-bottom: none;
        }

        .rank {
            font-weight: bold;
            color: #7f8c8d; /* 진한 회색 */
            width: 30px;
            text-align: center;
            margin-right: 10px;
        }

        .country-info {
            flex: 1;
            font-weight: 600;
            color: #34495e;
        }

        .score {
            font-weight: bold;
            color: #2980b9; /* 파란색 */
            font-size: 1.2em;
            min-width: 60px;
            text-align: right;
        }

        /* 푸터 스타일 */
        footer {
            background-color: #34495e;
            color: white;
            text-align: center;
            padding: 1rem;
            margin-top: auto; /* 하단에 고정 */
            box-shadow: 0 -3px 6px rgba(0,0,0,0.05);
        }

        /* 반응형 디자인 */
        @media (max-width: 992px) {
            main {
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
            }

            .sidebar {
                flex: none;
                width: 100%;
            }

            .map-container {
                width: 100%;
                height: 500px; /* 모바일에서 지도가 너무 작아지지 않도록 최소 높이 */
            }
        }

        @media (max-width: 576px) {
            header h1 {
                font-size: 1.5rem;
            }
            .sidebar {
                padding: 1rem;
            }
            .map-container {
                padding: 0.5rem;
            }
            h2 {
                font-size: 1.3rem;
                margin-bottom: 1rem;
            }
            .ncsi-list li {
                font-size: 1rem;
                padding: 0.6rem 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>National Cyber Security Index (NCSI) Top 20 Dashboard</h1>
    </header>

    <main>
        <div class="sidebar">
            <h2>NCSI TOP 20 국가</h2>
            <ul class="ncsi-list">
                {% for country in ncsi_data %}
                <li>
                    <span class="rank">{{ country.rank }}</span>
                    <div class="country-info">{{ country.country }}</div>
                    <span class="score">{{ country.security_index }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="map-container">
            <h2>세계 지도 시각화</h2>
            <div id="map"></div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 NCSI Dashboard. All rights reserved.</p>
    </footer>

    <script>
        // Leaflet 지도 초기화
        var map = L.map('map', {
            center: [0, 0],       // 지도의 초기 중심 좌표 (전 세계 중앙)
            zoom: 2,              // 지도의 초기 줌 레벨 (전 세계를 한눈에 볼 수 있도록)
            minZoom: 2,           // 최소 줌 레벨 (더 이상 축소되지 않음)
            maxZoom: 8,           // 최대 줌 레벨 (너무 깊이 확대되지 않음)
            dragging: false,      // 지도를 드래그하여 이동하는 기능 비활성화
            scrollWheelZoom: true // 마우스 휠로 확대/축소 기능 활성화
            // 기타 옵션 (doubleClickZoom, touchZoom, boxZoom, keyboard, zoomControl 등)도 필요에 따라 설정 가능
        });

        // OpenStreetMap 타일 레이어 추가
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // FastAPI 백엔드에서 전달받은 NCSI 데이터 (Jinja2 템플릿 변수)
        // 이 ncsi_data 변수는 main.py의 templates.TemplateResponse에서 context로 넘어옵니다.
        var ncsiData = {{ ncsi_data|tojson }};
        console.log("NCSI Data received in browser:", ncsiData); // <--- 이 줄 추가!
        // 데이터가 비어있지 않다면 마커 추가
        if (ncsiData && ncsiData.length > 0) {
            console.log("Data exists, attempting to add markers..."); // <--- 이 줄 추가!
            ncsiData.forEach(function(country) {
                // 위도와 경도 정보가 유효한 경우에만 마커를 추가
                if (country.latitude !== undefined && country.longitude !== undefined) {
                    var marker = L.marker([country.latitude, country.longitude]).addTo(map);

                    // 팝업 내용 설정
                    marker.bindPopup(
                        '<b>' + country.country + '</b><br>' +
                        '보안지수: ' + country.security_index + '<br>' +
                        '디지털수준: ' + country.digital_level + '<br>' +
                        '순위: ' + country.rank + '<br>' +
                        '차이값: ' + country.difference
                    );
                }
            });
        }
    </script>
</body>
</html>